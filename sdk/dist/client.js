"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TrustProtocolClient = void 0;
const ethers_1 = require("ethers");
const types_1 = require("./types");
const contracts_1 = require("./contracts");
/**
 * TrustProtocolClient
 *
 * Main SDK client for interacting with x402 Trust Protocol
 */
class TrustProtocolClient {
    constructor(config) {
        this.config = config;
        this.provider = new ethers_1.ethers.JsonRpcProvider(config.rpcUrl);
        this.signer = config.signer;
        const signerOrProvider = this.signer || this.provider;
        this.trustProtocol = new ethers_1.Contract(config.contracts.trustProtocol, contracts_1.TRUST_PROTOCOL_ABI, signerOrProvider);
        this.reputationEngine = new ethers_1.Contract(config.contracts.reputationEngine, contracts_1.REPUTATION_ENGINE_ABI, signerOrProvider);
        this.escrowVault = new ethers_1.Contract(config.contracts.escrowVault, contracts_1.ESCROW_VAULT_ABI, signerOrProvider);
        this.disputeManager = new ethers_1.Contract(config.contracts.disputeManager, contracts_1.DISPUTE_MANAGER_ABI, signerOrProvider);
        this.usdc = new ethers_1.Contract(config.contracts.usdc, contracts_1.ERC20_ABI, signerOrProvider);
    }
    // ═══════════════════════════════════════════════════════════════════════════
    // PROVIDER INFO
    // ═══════════════════════════════════════════════════════════════════════════
    /**
     * Get provider's trust score (300-900)
     */
    async getProviderScore(address) {
        const score = await this.reputationEngine.getScore(address);
        return Number(score);
    }
    /**
     * Get provider's trust tier
     */
    async getProviderTier(address) {
        const tier = await this.trustProtocol.getTrustTier(address);
        return tier;
    }
    /**
     * Get full provider stats
     */
    async getProviderStats(address) {
        const [score, tier, timeout, isActive] = await this.trustProtocol.getProviderInfo(address);
        const tierName = await this.trustProtocol.getTrustTier(address);
        return {
            address,
            score: Number(score),
            tier: tierName,
            successRate: 0, // Would need transaction history
            averageResponseTime: 0,
            totalTransactions: 0,
            disputeRate: 0,
            isActive
        };
    }
    /**
     * Check if provider requires escrow
     */
    async needsEscrow(address) {
        return await this.trustProtocol.needsEscrow(address);
    }
    /**
     * Compare multiple providers
     */
    async compareProviders(addresses) {
        const [scores, timeouts] = await this.trustProtocol.compareProviders(addresses);
        const comparisons = [];
        for (let i = 0; i < addresses.length; i++) {
            const tier = await this.trustProtocol.getTrustTier(addresses[i]);
            const score = Number(scores[i]);
            let recommendation = '';
            if (score >= 850)
                recommendation = 'Highly recommended - Elite provider';
            else if (score >= 700)
                recommendation = 'Recommended - Excellent track record';
            else if (score >= 500)
                recommendation = 'Acceptable - Use with escrow';
            else if (score >= 400)
                recommendation = 'Caution - Higher risk';
            else
                recommendation = 'Not recommended - Poor history';
            comparisons.push({
                address: addresses[i],
                score,
                tier: tier,
                timeout: Number(timeouts[i]),
                recommendation
            });
        }
        // Sort by score descending
        comparisons.sort((a, b) => b.score - a.score);
        return comparisons;
    }
    // ═══════════════════════════════════════════════════════════════════════════
    // PAYMENTS
    // ═══════════════════════════════════════════════════════════════════════════
    /**
     * Create a secure payment with trust-based routing
     */
    async createSecurePayment(params) {
        if (!this.signer) {
            throw new Error('Signer required for transactions');
        }
        // Check allowance and approve if needed
        const signerAddress = await this.signer.getAddress();
        const allowance = await this.usdc.allowance(signerAddress, this.config.contracts.escrowVault);
        if (allowance < params.amount) {
            const approveTx = await this.usdc.approve(this.config.contracts.escrowVault, params.amount);
            await approveTx.wait();
        }
        // Create payment
        const tx = await this.escrowVault.createPayment(params.provider, params.amount, params.requestHash);
        const receipt = await tx.wait();
        // Extract paymentId from event
        const event = receipt.logs.find((log) => log.fragment?.name === 'PaymentCreated');
        const paymentId = event.args[0];
        const useEscrow = event.args[4];
        const timeout = Number(event.args[5]);
        return {
            paymentId,
            escrowUsed: useEscrow,
            timeoutMinutes: Math.floor(timeout / 60),
            transactionHash: receipt.hash
        };
    }
    /**
     * Confirm delivery and release escrowed payment
     */
    async confirmDelivery(paymentId, proof) {
        if (!this.signer) {
            throw new Error('Signer required for transactions');
        }
        const proofStruct = {
            requestHash: proof.requestHash,
            responseHash: proof.responseHash,
            responseSize: proof.responseSize,
            schemaHash: proof.schemaHash || ethers_1.ethers.ZeroHash,
            signature: proof.signature
        };
        const tx = await this.escrowVault.confirmDelivery(paymentId, proofStruct);
        const receipt = await tx.wait();
        return receipt.hash;
    }
    /**
     * Claim refund after timeout
     */
    async claimTimeout(paymentId) {
        if (!this.signer) {
            throw new Error('Signer required for transactions');
        }
        const tx = await this.escrowVault.claimTimeout(paymentId);
        const receipt = await tx.wait();
        return receipt.hash;
    }
    /**
     * Get payment info
     */
    async getPayment(paymentId) {
        const p = await this.escrowVault.getPayment(paymentId);
        return {
            id: paymentId,
            buyer: p.buyer,
            provider: p.provider,
            amount: p.amount,
            requestHash: p.requestHash,
            createdAt: Number(p.createdAt),
            timeout: Number(p.timeout),
            status: Number(p.status),
            useEscrow: p.useEscrow
        };
    }
    /**
     * Get payment status
     */
    async getPaymentStatus(paymentId) {
        const status = await this.escrowVault.getPaymentStatus(paymentId);
        return Number(status);
    }
    // ═══════════════════════════════════════════════════════════════════════════
    // DISPUTES
    // ═══════════════════════════════════════════════════════════════════════════
    /**
     * Raise a dispute for a pending payment
     */
    async raiseDispute(paymentId, evidence) {
        if (!this.signer) {
            throw new Error('Signer required for transactions');
        }
        const evidenceHash = ethers_1.ethers.keccak256(ethers_1.ethers.toUtf8Bytes(evidence));
        const tx = await this.escrowVault.raiseDispute(paymentId, evidenceHash);
        const receipt = await tx.wait();
        // Get payment to determine track
        const payment = await this.getPayment(paymentId);
        const amount = payment.amount;
        let track = types_1.DisputeTrack.Standard;
        if (amount < BigInt(100e6))
            track = types_1.DisputeTrack.FastTrack;
        else if (amount >= BigInt(1000e6))
            track = types_1.DisputeTrack.Complex;
        // Extract disputeId from event
        const event = receipt.logs.find((log) => log.fragment?.name === 'DisputeRaised');
        return {
            disputeId: event.args[1],
            track,
            transactionHash: receipt.hash
        };
    }
    // ═══════════════════════════════════════════════════════════════════════════
    // REGISTRATION
    // ═══════════════════════════════════════════════════════════════════════════
    /**
     * Register as a provider with stake
     */
    async registerAsProvider(endpoint) {
        if (!this.signer) {
            throw new Error('Signer required for transactions');
        }
        // Get required stake
        const stake = await this.reputationEngine.PROVIDER_STAKE();
        // Check and approve USDC
        const signerAddress = await this.signer.getAddress();
        const allowance = await this.usdc.allowance(signerAddress, this.config.contracts.reputationEngine);
        if (allowance < stake) {
            const approveTx = await this.usdc.approve(this.config.contracts.reputationEngine, stake);
            await approveTx.wait();
        }
        // Register
        const tx = await this.reputationEngine.registerWithStake(endpoint);
        const receipt = await tx.wait();
        return receipt.hash;
    }
    /**
     * Register as an arbitrator
     */
    async registerAsArbitrator() {
        if (!this.signer) {
            throw new Error('Signer required for transactions');
        }
        // Get required stake
        const stake = await this.disputeManager.ARBITRATOR_STAKE();
        // Check and approve USDC
        const signerAddress = await this.signer.getAddress();
        const allowance = await this.usdc.allowance(signerAddress, this.config.contracts.disputeManager);
        if (allowance < stake) {
            const approveTx = await this.usdc.approve(this.config.contracts.disputeManager, stake);
            await approveTx.wait();
        }
        // Register
        const tx = await this.disputeManager.registerAsArbitrator();
        const receipt = await tx.wait();
        return receipt.hash;
    }
    // ═══════════════════════════════════════════════════════════════════════════
    // UTILITIES
    // ═══════════════════════════════════════════════════════════════════════════
    /**
     * Get USDC balance
     */
    async getUsdcBalance(address) {
        return await this.usdc.balanceOf(address);
    }
    /**
     * Hash a request for payment creation
     */
    hashRequest(request) {
        return ethers_1.ethers.keccak256(ethers_1.ethers.toUtf8Bytes(request));
    }
    /**
     * Hash a response for delivery proof
     */
    hashResponse(response) {
        return ethers_1.ethers.keccak256(ethers_1.ethers.toUtf8Bytes(response));
    }
}
exports.TrustProtocolClient = TrustProtocolClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBNEQ7QUFDNUQsbUNBV2lCO0FBQ2pCLDJDQU1xQjtBQUVyQjs7OztHQUlHO0FBQ0gsTUFBYSxtQkFBbUI7SUFZNUIsWUFBWSxNQUEyQjtRQUNuQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksZUFBTSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO1FBRTVCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDO1FBRXRELElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxpQkFBUSxDQUM3QixNQUFNLENBQUMsU0FBUyxDQUFDLGFBQWEsRUFDOUIsOEJBQWtCLEVBQ2xCLGdCQUFnQixDQUNuQixDQUFDO1FBRUYsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksaUJBQVEsQ0FDaEMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsRUFDakMsaUNBQXFCLEVBQ3JCLGdCQUFnQixDQUNuQixDQUFDO1FBRUYsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLGlCQUFRLENBQzNCLE1BQU0sQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUM1Qiw0QkFBZ0IsRUFDaEIsZ0JBQWdCLENBQ25CLENBQUM7UUFFRixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksaUJBQVEsQ0FDOUIsTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQy9CLCtCQUFtQixFQUNuQixnQkFBZ0IsQ0FDbkIsQ0FBQztRQUVGLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxpQkFBUSxDQUNwQixNQUFNLENBQUMsU0FBUyxDQUFDLElBQUks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QUFDLGNBQWMsQ0FBQyxPQUFlO1FBQ2hDLE9BQU8sTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxXQUFXLENBQUMsT0FBZTtRQUN2QixPQUFPLGVBQU0sQ0FBQyxTQUFTLENBQUMsZUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFRDs7T0FFRztJQUNILFlBQVksQ0FBQyxRQUFnQjtRQUN6QixPQUFPLGVBQU0sQ0FBQyxTQUFTLENBQUMsZUFBTSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQzFELENBQUM7Q0FDSjtBQS9XRCxrREErV0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBldGhlcnMsIENvbnRyYWN0LCBTaWduZXIsIFByb3ZpZGVyIH0gZnJvbSAnZXRoZXJzJztcbmltcG9ydCB7XG4gICAgVHJ1c3RQcm90b2NvbENvbmZpZyxcbiAgICBQcm92aWRlclN0YXRzLFxuICAgIFByb3ZpZGVyQ29tcGFyaXNvbixcbiAgICBQYXltZW50UmVzdWx0LFxuICAgIERlbGl2ZXJ5UHJvb2YsXG4gICAgUGF5bWVudCxcbiAgICBQYXltZW50U3RhdHVzLFxuICAgIFRydXN0VGllcixcbiAgICBEaXNwdXRlLFxuICAgIERpc3B1dGVUcmFja1xufSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7XG4gICAgVFJVU1RfUFJPVE9DT0xfQUJJLFxuICAgIFJFUFVUQVRJT05fRU5HSU5FX0FCSSxcbiAgICBFU0NST1dfVkFVTFRfQUJJLFxuICAgIERJU1BVVEVfTUFOQUdFUl9BQkksXG4gICAgRVJDMjBfQUJJXG59IGZyb20gJy4vY29udHJhY3RzJztcblxuLyoqXG4gKiBUcnVzdFByb3RvY29sQ2xpZW50XG4gKiBcbiAqIE1haW4gU0RLIGNsaWVudCBmb3IgaW50ZXJhY3Rpbmcgd2l0aCB4NDAyIFRydXN0IFByb3RvY29sXG4gKi9cbmV4cG9ydCBjbGFzcyBUcnVzdFByb3RvY29sQ2xpZW50IHtcbiAgICBwcml2YXRlIHByb3ZpZGVyOiBQcm92aWRlcjtcbiAgICBwcml2YXRlIHNpZ25lcj86IFNpZ25lcjtcbiAgICBwcml2YXRlIGNvbmZpZzogVHJ1c3RQcm90b2NvbENvbmZpZztcblxuICAgIC8vIENvbnRyYWN0IGluc3RhbmNlc1xuICAgIHByaXZhdGUgdHJ1c3RQcm90b2NvbDogQ29udHJhY3Q7XG4gICAgcHJpdmF0ZSByZXB1dGF0aW9uRW5naW5lOiBDb250cmFjdDtcbiAgICBwcml2YXRlIGVzY3Jvd1ZhdWx0OiBDb250cmFjdDtcbiAgICBwcml2YXRlIGRpc3B1dGVNYW5hZ2VyOiBDb250cmFjdDtcbiAgICBwcml2YXRlIHVzZGM6IENvbnRyYWN0O1xuXG4gICAgY29uc3RydWN0b3IoY29uZmlnOiBUcnVzdFByb3RvY29sQ29uZmlnKSB7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgICAgICB0aGlzLnByb3ZpZGVyID0gbmV3IGV0aGVycy5Kc29uUnBjUHJvdmlkZXIoY29uZmlnLnJwY1VybCk7XG4gICAgICAgIHRoaXMuc2lnbmVyID0gY29uZmlnLnNpZ25lcjtcblxuICAgICAgICBjb25zdCBzaWduZXJPclByb3ZpZGVyID0gdGhpcy5zaWduZXIgfHwgdGhpcy5wcm92aWRlcjtcblxuICAgICAgICB0aGlzLnRydXN0UHJvdG9jb2wgPSBuZXcgQ29udHJhY3QoXG4gICAgICAgICAgICBjb25maWcuY29udHJhY3RzLnRydXN0UHJvdG9jb2wsXG4gICAgICAgICAgICBUUlVTVF9QUk9UT0NPTF9BQkksXG4gICAgICAgICAgICBzaWduZXJPclByb3ZpZGVyXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5yZXB1dGF0aW9uRW5naW5lID0gbmV3IENvbnRyYWN0KFxuICAgICAgICAgICAgY29uZmlnLmNvbnRyYWN0cy5yZXB1dGF0aW9uRW5naW5lLFxuICAgICAgICAgICAgUkVQVVRBVElPTl9FTkdJTkVfQUJJLFxuICAgICAgICAgICAgc2lnbmVyT3JQcm92aWRlclxuICAgICAgICApO1xuXG4gICAgICAgIHRoaXMuZXNjcm93VmF1bHQgPSBuZXcgQ29udHJhY3QoXG4gICAgICAgICAgICBjb25maWcuY29udHJhY3RzLmVzY3Jvd1ZhdWx0LFxuICAgICAgICAgICAgRVNDUk9XX1ZBVUxUX0FCSSxcbiAgICAgICAgICAgIHNpZ25lck9yUHJvdmlkZXJcbiAgICAgICAgKTtcblxuICAgICAgICB0aGlzLmRpc3B1dGVNYW5hZ2VyID0gbmV3IENvbnRyYWN0KFxuICAgICAgICAgICAgY29uZmlnLmNvbnRyYWN0cy5kaXNwdXRlTWFuYWdlcixcbiAgICAgICAgICAgIERJU1BVVEVfTUFOQUdFUl9BQkksXG4gICAgICAgICAgICBzaWduZXJPclByb3ZpZGVyXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy51c2RjID0gbmV3IENvbnRyYWN0KFxuICAgICAgICAgICAgY29uZmlnLmNvbnRyYWN0cy51c2RjLFxuICAgICAgICAgICAgRVJDMjBfQUJJLFxuICAgICAgICAgICAgc2lnbmVyT3JQcm92aWRlclxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8vIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkFxuICAgIC8vIFBST1ZJREVSIElORk9cbiAgICAvLyDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZBcblxuICAgIC8qKlxuICAgICAqIEdldCBwcm92aWRlcidzIHRydXN0IHNjb3JlICgzMDAtOTAwKVxuICAgICAqL1xuICAgIGFzeW5jIGdldFByb3ZpZGVyU2NvcmUoYWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgY29uc3Qgc2NvcmUgPSBhd2FpdCB0aGlzLnJlcHV0YXRpb25FbmdpbmUuZ2V0U2NvcmUoYWRkcmVzcyk7XG4gICAgICAgIHJldHVybiBOdW1iZXIoc2NvcmUpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBwcm92aWRlcidzIHRydXN0IHRpZXJcbiAgICAgKi9cbiAgICBhc3luYyBnZXRQcm92aWRlclRpZXIoYWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxUcnVzdFRpZXI+IHtcbiAgICAgICAgY29uc3QgdGllciA9IGF3YWl0IHRoaXMudHJ1c3RQcm90b2NvbC5nZXRUcnVzdFRpZXIoYWRkcmVzcyk7XG4gICAgICAgIHJldHVybiB0aWVyIGFzIFRydXN0VGllcjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgZnVsbCBwcm92aWRlciBzdGF0c1xuICAgICAqL1xuICAgIGFzeW5jIGdldFByb3ZpZGVyU3RhdHMoYWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxQcm92aWRlclN0YXRzPiB7XG4gICAgICAgIGNvbnN0IFtzY29yZSwgdGllciwgdGltZW91dCwgaXNBY3RpdmVdID0gYXdhaXQgdGhpcy50cnVzdFByb3RvY29sLmdldFByb3ZpZGVySW5mbyhhZGRyZXNzKTtcbiAgICAgICAgY29uc3QgdGllck5hbWUgPSBhd2FpdCB0aGlzLnRydXN0UHJvdG9jb2wuZ2V0VHJ1c3RUaWVyKGFkZHJlc3MpO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBhZGRyZXNzLFxuICAgICAgICAgICAgc2NvcmU6IE51bWJlcihzY29yZSksXG4gICAgICAgICAgICB0aWVyOiB0aWVyTmFtZSBhcyBUcnVzdFRpZXIsXG4gICAgICAgICAgICBzdWNjZXNzUmF0ZTogMCwgLy8gV291bGQgbmVlZCB0cmFuc2FjdGlvbiBoaXN0b3J5XG4gICAgICAgICAgICBhdmVyYWdlUmVzcG9uc2VUaW1lOiAwLFxuICAgICAgICAgICAgdG90YWxUcmFuc2FjdGlvbnM6IDAsXG4gICAgICAgICAgICBkaXNwdXRlUmF0ZTogMCxcbiAgICAgICAgICAgIGlzQWN0aXZlXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWYgcHJvdmlkZXIgcmVxdWlyZXMgZXNjcm93XG4gICAgICovXG4gICAgYXN5bmMgbmVlZHNFc2Nyb3coYWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRydXN0UHJvdG9jb2wubmVlZHNFc2Nyb3coYWRkcmVzcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29tcGFyZSBtdWx0aXBsZSBwcm92aWRlcnNcbiAgICAgKi9cbiAgICBhc3luYyBjb21wYXJlUHJvdmlkZXJzKGFkZHJlc3Nlczogc3RyaW5nW10pOiBQcm9taXNlPFByb3ZpZGVyQ29tcGFyaXNvbltdPiB7XG4gICAgICAgIGNvbnN0IFtzY29yZXMsIHRpbWVvdXRzXSA9IGF3YWl0IHRoaXMudHJ1c3RQcm90b2NvbC5jb21wYXJlUHJvdmlkZXJzKGFkZHJlc3Nlcyk7XG5cbiAgICAgICAgY29uc3QgY29tcGFyaXNvbnM6IFByb3ZpZGVyQ29tcGFyaXNvbltdID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhZGRyZXNzZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHRpZXIgPSBhd2FpdCB0aGlzLnRydXN0UHJvdG9jb2wuZ2V0VHJ1c3RUaWVyKGFkZHJlc3Nlc1tpXSk7XG4gICAgICAgICAgICBjb25zdCBzY29yZSA9IE51bWJlcihzY29yZXNbaV0pO1xuXG4gICAgICAgICAgICBsZXQgcmVjb21tZW5kYXRpb24gPSAnJztcbiAgICAgICAgICAgIGlmIChzY29yZSA+PSA4NTApIHJlY29tbWVuZGF0aW9uID0gJ0hpZ2hseSByZWNvbW1lbmRlZCAtIEVsaXRlIHByb3ZpZGVyJztcbiAgICAgICAgICAgIGVsc2UgaWYgKHNjb3JlID49IDcwMCkgcmVjb21tZW5kYXRpb24gPSAnUmVjb21tZW5kZWQgLSBFeGNlbGxlbnQgdHJhY2sgcmVjb3JkJztcbiAgICAgICAgICAgIGVsc2UgaWYgKHNjb3JlID49IDUwMCkgcmVjb21tZW5kYXRpb24gPSAnQWNjZXB0YWJsZSAtIFVzZSB3aXRoIGVzY3Jvdyc7XG4gICAgICAgICAgICBlbHNlIGlmIChzY29yZSA+PSA0MDApIHJlY29tbWVuZGF0aW9uID0gJ0NhdXRpb24gLSBIaWdoZXIgcmlzayc7XG4gICAgICAgICAgICBlbHNlIHJlY29tbWVuZGF0aW9uID0gJ05vdCByZWNvbW1lbmRlZCAtIFBvb3IgaGlzdG9yeSc7XG5cbiAgICAgICAgICAgIGNvbXBhcmlzb25zLnB1c2goe1xuICAgICAgICAgICAgICAgIGFkZHJlc3M6IGFkZHJlc3Nlc1tpXSxcbiAgICAgICAgICAgICAgICBzY29yZSxcbiAgICAgICAgICAgICAgICB0aWVyOiB0aWVyIGFzIFRydXN0VGllcixcbiAgICAgICAgICAgICAgICB0aW1lb3V0OiBOdW1iZXIodGltZW91dHNbaV0pLFxuICAgICAgICAgICAgICAgIHJlY29tbWVuZGF0aW9uXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNvcnQgYnkgc2NvcmUgZGVzY2VuZGluZ1xuICAgICAgICBjb21wYXJpc29ucy5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSk7XG5cbiAgICAgICAgcmV0dXJuIGNvbXBhcmlzb25zO1xuICAgIH1cblxuICAgIC8vIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkFxuICAgIC8vIFBBWU1FTlRTXG4gICAgLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQXG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBzZWN1cmUgcGF5bWVudCB3aXRoIHRydXN0LWJhc2VkIHJvdXRpbmdcbiAgICAgKi9cbiAgICBhc3luYyBjcmVhdGVTZWN1cmVQYXltZW50KHBhcmFtczoge1xuICAgICAgICBwcm92aWRlcjogc3RyaW5nO1xuICAgICAgICBhbW91bnQ6IGJpZ2ludDtcbiAgICAgICAgcmVxdWVzdEhhc2g6IHN0cmluZztcbiAgICB9KTogUHJvbWlzZTxQYXltZW50UmVzdWx0PiB7XG4gICAgICAgIGlmICghdGhpcy5zaWduZXIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU2lnbmVyIHJlcXVpcmVkIGZvciB0cmFuc2FjdGlvbnMnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGFsbG93YW5jZSBhbmQgYXBwcm92ZSBpZiBuZWVkZWRcbiAgICAgICAgY29uc3Qgc2lnbmVyQWRkcmVzcyA9IGF3YWl0IHRoaXMuc2lnbmVyLmdldEFkZHJlc3MoKTtcbiAgICAgICAgY29uc3QgYWxsb3dhbmNlID0gYXdhaXQgdGhpcy51c2RjLmFsbG93YW5jZShzaWduZXJBZGRyZXNzLCB0aGlzLmNvbmZpZy5jb250cmFjdHMuZXNjcm93VmF1bHQpO1xuXG4gICAgICAgIGlmIChhbGxvd2FuY2UgPCBwYXJhbXMuYW1vdW50KSB7XG4gICAgICAgICAgICBjb25zdCBhcHByb3ZlVHggPSBhd2FpdCB0aGlzLnVzZGMuYXBwcm92ZSh0aGlzLmNvbmZpZy5jb250cmFjdHMuZXNjcm93VmF1bHQsIHBhcmFtcy5hbW91bnQpO1xuICAgICAgICAgICAgYXdhaXQgYXBwcm92ZVR4LndhaXQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENyZWF0ZSBwYXltZW50XG4gICAgICAgIGNvbnN0IHR4ID0gYXdhaXQgdGhpcy5lc2Nyb3dWYXVsdC5jcmVhdGVQYXltZW50KFxuICAgICAgICAgICAgcGFyYW1zLnByb3ZpZGVyLFxuICAgICAgICAgICAgcGFyYW1zLmFtb3VudCxcbiAgICAgICAgICAgIHBhcmFtcy5yZXF1ZXN0SGFzaFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IHJlY2VpcHQgPSBhd2FpdCB0eC53YWl0KCk7XG5cbiAgICAgICAgLy8gRXh0cmFjdCBwYXltZW50SWQgZnJvbSBldmVudFxuICAgICAgICBjb25zdCBldmVudCA9IHJlY2VpcHQubG9ncy5maW5kKFxuICAgICAgICAgICAgKGxvZzogYW55KSA9PiBsb2cuZnJhZ21lbnQ/Lm5hbWUgPT09ICdQYXltZW50Q3JlYXRlZCdcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBwYXltZW50SWQgPSBldmVudC5hcmdzWzBdO1xuICAgICAgICBjb25zdCB1c2VFc2Nyb3cgPSBldmVudC5hcmdzWzRdO1xuICAgICAgICBjb25zdCB0aW1lb3V0ID0gTnVtYmVyKGV2ZW50LmFyZ3NbNV0pO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBwYXltZW50SWQsXG4gICAgICAgICAgICBlc2Nyb3dVc2VkOiB1c2VFc2Nyb3csXG4gICAgICAgICAgICB0aW1lb3V0TWludXRlczogTWF0aC5mbG9vcih0aW1lb3V0IC8gNjApLFxuICAgICAgICAgICAgdHJhbnNhY3Rpb25IYXNoOiByZWNlaXB0Lmhhc2hcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDb25maXJtIGRlbGl2ZXJ5IGFuZCByZWxlYXNlIGVzY3Jvd2VkIHBheW1lbnRcbiAgICAgKi9cbiAgICBhc3luYyBjb25maXJtRGVsaXZlcnkocGF5bWVudElkOiBzdHJpbmcsIHByb29mOiBEZWxpdmVyeVByb29mKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgICAgaWYgKCF0aGlzLnNpZ25lcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdTaWduZXIgcmVxdWlyZWQgZm9yIHRyYW5zYWN0aW9ucycpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcHJvb2ZTdHJ1Y3QgPSB7XG4gICAgICAgICAgICByZXF1ZXN0SGFzaDogcHJvb2YucmVxdWVzdEhhc2gsXG4gICAgICAgICAgICByZXNwb25zZUhhc2g6IHByb29mLnJlc3BvbnNlSGFzaCxcbiAgICAgICAgICAgIHJlc3BvbnNlU2l6ZTogcHJvb2YucmVzcG9uc2VTaXplLFxuICAgICAgICAgICAgc2NoZW1hSGFzaDogcHJvb2Yuc2NoZW1hSGFzaCB8fCBldGhlcnMuWmVyb0hhc2gsXG4gICAgICAgICAgICBzaWduYXR1cmU6IHByb29mLnNpZ25hdHVyZVxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHR4ID0gYXdhaXQgdGhpcy5lc2Nyb3dWYXVsdC5jb25maXJtRGVsaXZlcnkocGF5bWVudElkLCBwcm9vZlN0cnVjdCk7XG4gICAgICAgIGNvbnN0IHJlY2VpcHQgPSBhd2FpdCB0eC53YWl0KCk7XG5cbiAgICAgICAgcmV0dXJuIHJlY2VpcHQuaGFzaDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDbGFpbSByZWZ1bmQgYWZ0ZXIgdGltZW91dFxuICAgICAqL1xuICAgIGFzeW5jIGNsYWltVGltZW91dChwYXltZW50SWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIGlmICghdGhpcy5zaWduZXIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU2lnbmVyIHJlcXVpcmVkIGZvciB0cmFuc2FjdGlvbnMnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHR4ID0gYXdhaXQgdGhpcy5lc2Nyb3dWYXVsdC5jbGFpbVRpbWVvdXQocGF5bWVudElkKTtcbiAgICAgICAgY29uc3QgcmVjZWlwdCA9IGF3YWl0IHR4LndhaXQoKTtcblxuICAgICAgICByZXR1cm4gcmVjZWlwdC5oYXNoO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBwYXltZW50IGluZm9cbiAgICAgKi9cbiAgICBhc3luYyBnZXRQYXltZW50KHBheW1lbnRJZDogc3RyaW5nKTogUHJvbWlzZTxQYXltZW50PiB7XG4gICAgICAgIGNvbnN0IHAgPSBhd2FpdCB0aGlzLmVzY3Jvd1ZhdWx0LmdldFBheW1lbnQocGF5bWVudElkKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaWQ6IHBheW1lbnRJZCxcbiAgICAgICAgICAgIGJ1eWVyOiBwLmJ1eWVyLFxuICAgICAgICAgICAgcHJvdmlkZXI6IHAucHJvdmlkZXIsXG4gICAgICAgICAgICBhbW91bnQ6IHAuYW1vdW50LFxuICAgICAgICAgICAgcmVxdWVzdEhhc2g6IHAucmVxdWVzdEhhc2gsXG4gICAgICAgICAgICBjcmVhdGVkQXQ6IE51bWJlcihwLmNyZWF0ZWRBdCksXG4gICAgICAgICAgICB0aW1lb3V0OiBOdW1iZXIocC50aW1lb3V0KSxcbiAgICAgICAgICAgIHN0YXR1czogTnVtYmVyKHAuc3RhdHVzKSBhcyBQYXltZW50U3RhdHVzLFxuICAgICAgICAgICAgdXNlRXNjcm93OiBwLnVzZUVzY3Jvd1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBwYXltZW50IHN0YXR1c1xuICAgICAqL1xuICAgIGFzeW5jIGdldFBheW1lbnRTdGF0dXMocGF5bWVudElkOiBzdHJpbmcpOiBQcm9taXNlPFBheW1lbnRTdGF0dXM+IHtcbiAgICAgICAgY29uc3Qgc3RhdHVzID0gYXdhaXQgdGhpcy5lc2Nyb3dWYXVsdC5nZXRQYXltZW50U3RhdHVzKHBheW1lbnRJZCk7XG4gICAgICAgIHJldHVybiBOdW1iZXIoc3RhdHVzKSBhcyBQYXltZW50U3RhdHVzO1xuICAgIH1cblxuICAgIC8vIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkFxuICAgIC8vIERJU1BVVEVTXG4gICAgLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQXG5cbiAgICAvKipcbiAgICAgKiBSYWlzZSBhIGRpc3B1dGUgZm9yIGEgcGVuZGluZyBwYXltZW50XG4gICAgICovXG4gICAgYXN5bmMgcmFpc2VEaXNwdXRlKHBheW1lbnRJZDogc3RyaW5nLCBldmlkZW5jZTogc3RyaW5nKTogUHJvbWlzZTx7XG4gICAgICAgIGRpc3B1dGVJZDogc3RyaW5nO1xuICAgICAgICB0cmFjazogRGlzcHV0ZVRyYWNrO1xuICAgICAgICB0cmFuc2FjdGlvbkhhc2g6IHN0cmluZztcbiAgICB9PiB7XG4gICAgICAgIGlmICghdGhpcy5zaWduZXIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU2lnbmVyIHJlcXVpcmVkIGZvciB0cmFuc2FjdGlvbnMnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGV2aWRlbmNlSGFzaCA9IGV0aGVycy5rZWNjYWsyNTYoZXRoZXJzLnRvVXRmOEJ5dGVzKGV2aWRlbmNlKSk7XG5cbiAgICAgICAgY29uc3QgdHggPSBhd2FpdCB0aGlzLmVzY3Jvd1ZhdWx0LnJhaXNlRGlzcHV0ZShwYXltZW50SWQsIGV2aWRlbmNlSGFzaCk7XG4gICAgICAgIGNvbnN0IHJlY2VpcHQgPSBhd2FpdCB0eC53YWl0KCk7XG5cbiAgICAgICAgLy8gR2V0IHBheW1lbnQgdG8gZGV0ZXJtaW5lIHRyYWNrXG4gICAgICAgIGNvbnN0IHBheW1lbnQgPSBhd2FpdCB0aGlzLmdldFBheW1lbnQocGF5bWVudElkKTtcbiAgICAgICAgY29uc3QgYW1vdW50ID0gcGF5bWVudC5hbW91bnQ7XG5cbiAgICAgICAgbGV0IHRyYWNrID0gRGlzcHV0ZVRyYWNrLlN0YW5kYXJkO1xuICAgICAgICBpZiAoYW1vdW50IDwgQmlnSW50KDEwMGU2KSkgdHJhY2sgPSBEaXNwdXRlVHJhY2suRmFzdFRyYWNrO1xuICAgICAgICBlbHNlIGlmIChhbW91bnQgPj0gQmlnSW50KDEwMDBlNikpIHRyYWNrID0gRGlzcHV0ZVRyYWNrLkNvbXBsZXg7XG5cbiAgICAgICAgLy8gRXh0cmFjdCBkaXNwdXRlSWQgZnJvbSBldmVudFxuICAgICAgICBjb25zdCBldmVudCA9IHJlY2VpcHQubG9ncy5maW5kKFxuICAgICAgICAgICAgKGxvZzogYW55KSA9PiBsb2cuZnJhZ21lbnQ/Lm5hbWUgPT09ICdEaXNwdXRlUmFpc2VkJ1xuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBkaXNwdXRlSWQ6IGV2ZW50LmFyZ3NbMV0sXG4gICAgICAgICAgICB0cmFjayxcbiAgICAgICAgICAgIHRyYW5zYWN0aW9uSGFzaDogcmVjZWlwdC5oYXNoXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQXG4gICAgLy8gUkVHSVNUUkFUSU9OXG4gICAgLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQXG5cbiAgICAvKipcbiAgICAgKiBSZWdpc3RlciBhcyBhIHByb3ZpZGVyIHdpdGggc3Rha2VcbiAgICAgKi9cbiAgICBhc3luYyByZWdpc3RlckFzUHJvdmlkZXIoZW5kcG9pbnQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIGlmICghdGhpcy5zaWduZXIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU2lnbmVyIHJlcXVpcmVkIGZvciB0cmFuc2FjdGlvbnMnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEdldCByZXF1aXJlZCBzdGFrZVxuICAgICAgICBjb25zdCBzdGFrZSA9IGF3YWl0IHRoaXMucmVwdXRhdGlvbkVuZ2luZS5QUk9WSURFUl9TVEFLRSgpO1xuXG4gICAgICAgIC8vIENoZWNrIGFuZCBhcHByb3ZlIFVTRENcbiAgICAgICAgY29uc3Qgc2lnbmVyQWRkcmVzcyA9IGF3YWl0IHRoaXMuc2lnbmVyLmdldEFkZHJlc3MoKTtcbiAgICAgICAgY29uc3QgYWxsb3dhbmNlID0gYXdhaXQgdGhpcy51c2RjLmFsbG93YW5jZShzaWduZXJBZGRyZXNzLCB0aGlzLmNvbmZpZy5jb250cmFjdHMucmVwdXRhdGlvbkVuZ2luZSk7XG5cbiAgICAgICAgaWYgKGFsbG93YW5jZSA8IHN0YWtlKSB7XG4gICAgICAgICAgICBjb25zdCBhcHByb3ZlVHggPSBhd2FpdCB0aGlzLnVzZGMuYXBwcm92ZSh0aGlzLmNvbmZpZy5jb250cmFjdHMucmVwdXRhdGlvbkVuZ2luZSwgc3Rha2UpO1xuICAgICAgICAgICAgYXdhaXQgYXBwcm92ZVR4LndhaXQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJlZ2lzdGVyXG4gICAgICAgIGNvbnN0IHR4ID0gYXdhaXQgdGhpcy5yZXB1dGF0aW9uRW5naW5lLnJlZ2lzdGVyV2l0aFN0YWtlKGVuZHBvaW50KTtcbiAgICAgICAgY29uc3QgcmVjZWlwdCA9IGF3YWl0IHR4LndhaXQoKTtcblxuICAgICAgICByZXR1cm4gcmVjZWlwdC5oYXNoO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlZ2lzdGVyIGFzIGFuIGFyYml0cmF0b3JcbiAgICAgKi9cbiAgICBhc3luYyByZWdpc3RlckFzQXJiaXRyYXRvcigpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICBpZiAoIXRoaXMuc2lnbmVyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NpZ25lciByZXF1aXJlZCBmb3IgdHJhbnNhY3Rpb25zJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBHZXQgcmVxdWlyZWQgc3Rha2VcbiAgICAgICAgY29uc3Qgc3Rha2UgPSBhd2FpdCB0aGlzLmRpc3B1dGVNYW5hZ2VyLkFSQklUUkFUT1JfU1RBS0UoKTtcblxuICAgICAgICAvLyBDaGVjayBhbmQgYXBwcm92ZSBVU0RDXG4gICAgICAgIGNvbnN0IHNpZ25lckFkZHJlc3MgPSBhd2FpdCB0aGlzLnNpZ25lci5nZXRBZGRyZXNzKCk7XG4gICAgICAgIGNvbnN0IGFsbG93YW5jZSA9IGF3YWl0IHRoaXMudXNkYy5hbGxvd2FuY2Uoc2lnbmVyQWRkcmVzcywgdGhpcy5jb25maWcuY29udHJhY3RzLmRpc3B1dGVNYW5hZ2VyKTtcblxuICAgICAgICBpZiAoYWxsb3dhbmNlIDwgc3Rha2UpIHtcbiAgICAgICAgICAgIGNvbnN0IGFwcHJvdmVUeCA9IGF3YWl0IHRoaXMudXNkYy5hcHByb3ZlKHRoaXMuY29uZmlnLmNvbnRyYWN0cy5kaXNwdXRlTWFuYWdlciwgc3Rha2UpO1xuICAgICAgICAgICAgYXdhaXQgYXBwcm92ZVR4LndhaXQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJlZ2lzdGVyXG4gICAgICAgIGNvbnN0IHR4ID0gYXdhaXQgdGhpcy5kaXNwdXRlTWFuYWdlci5yZWdpc3RlckFzQXJiaXRyYXRvcigpO1xuICAgICAgICBjb25zdCByZWNlaXB0ID0gYXdhaXQgdHgud2FpdCgpO1xuXG4gICAgICAgIHJldHVybiByZWNlaXB0Lmhhc2g7XG4gICAgfVxuXG4gICAgLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQXG4gICAgLy8gVVRJTElUSUVTXG4gICAgLy8g4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQXG5cbiAgICAvKipcbiAgICAgKiBHZXQgVVNEQyBiYWxhbmNlXG4gICAgICovXG4gICAgYXN5bmMgZ2V0VXNkY0JhbGFuY2UoYWRkcmVzczogc3RyaW5nKTogUHJvbWlzZTxiaWdpbnQ+IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudXNkYy5iYWxhbmNlT2YoYWRkcmVzcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSGFzaCBhIHJlcXVlc3QgZm9yIHBheW1lbnQgY3JlYXRpb25cbiAgICAgKi9cbiAgICBoYXNoUmVxdWVzdChyZXF1ZXN0OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gZXRoZXJzLmtlY2NhazI1NihldGhlcnMudG9VdGY4Qnl0ZXMocmVxdWVzdCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhhc2ggYSByZXNwb25zZSBmb3IgZGVsaXZlcnkgcHJvb2ZcbiAgICAgKi9cbiAgICBoYXNoUmVzcG9uc2UocmVzcG9uc2U6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBldGhlcnMua2VjY2FrMjU2KGV0aGVycy50b1V0ZjhCeXRlcyhyZXNwb25zZSkpO1xuICAgIH1cbn1cbiJdfQ==